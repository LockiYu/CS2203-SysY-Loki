# 编译器开发协作方案

## 编译阶段划分

### 1. 词法分析（负责人：郑良飞）

**输入**：SysY源代码文件（.c文件）  
**输出**：词法单元(Token)流  
**核心文件**：`lexer.l`，`lexer.cpp`

**对上阶段要求**：无（作为首个阶段）

**负责人工作内容**：

- 定义和实现语言的词法规则
- 识别关键字、标识符、常量、运算符和分隔符
- 处理注释和空白字符
- 提供详细的词法错误报告

### 2. 语法分析（负责人：董丽馨）

**输入**：词法单元流  
**输出**：抽象语法树(AST)  
**核心文件**：`parser.y`，`parser.cpp`，`ast.h`，`ast.cpp`

**对上阶段要求**：

- Token必须规范化，便于语法分析
- 应提供位置信息以助于错误定位

**负责人工作内容**：

- 定义SysY语言的语法规则
- 构建抽象语法树
- 实现语法错误恢复机制
- 与词法分析阶段对接

### 3. 语义分析（负责人：王梦冉）

**输入**：抽象语法树(AST)  
**输出**：带类型检查和符号表的增强AST  
**核心文件**：`symtab.cpp`，`typesys.cpp`，`IRSemanticAnalysis.cpp`

**对上阶段要求**：

- AST结构必须完整，能反映程序结构
- 节点间关系必须正确建立

**负责人工作内容**：

- 构建和管理符号表
- 实现类型检查系统
- 进行作用域分析
- 检查变量定义和使用
- 生成语义错误报告

### 4. 中间代码生成与优化（负责人：于豪杰）

**输入**：增强AST与符号表  
**输出**：优化后的LLVM IR代码  
**核心文件**：`unit.cpp`，`function.cpp`，`instruction.cpp`，`Mem2Reg.cpp`，`DeadCodeElimination.cpp`，`SSCP.cpp`等

**对上阶段要求**：

- 完整的类型信息和符号表
- 语义正确的AST

**负责人工作内容**：

- 将AST转换为LLVM IR
- 实现SSA形式的IR表示
- 设计和实现各种优化pass
- 管理中间代码的优化流程
- 生成可读的IR文本表示

### 5. 目标代码生成（负责人：张濮岩）

**输入**：LLVM IR代码  
**输出**：ARM汇编代码或可执行文件  
**核心文件**：`machine.cpp`，`run.sh`

**对上阶段要求**：

- IR代码必须符合LLVM规范
- 关键优化应已完成

**负责人工作内容**：

- 将LLVM IR转换为ARM汇编
- 处理寄存器分配
- 管理函数调用约定
- 处理平台特定优化
- 与LLVM工具链对接

## 协作方案

### 接口约定

1. **词法-语法接口**：定义Token结构和传递机制
2. **语法-语义接口**：确定AST节点结构和访问方法
3. **语义-IR接口**：商定符号表结构和类型系统表示
4. **IR-目标代码接口**：确定LLVM IR格式和生成策略

### 协作工具

1. **版本控制**：使用Git管理代码，建立分支开发模式
2. **单元测试**：每个阶段建立独立测试集
3. **集成测试**：设计端到端测试样例
4. **文档共享**：维护接口文档和开发规范

### 开发流程

1. **自顶向下设计**：先确定接口，再各自实现
2. **增量开发**：从简单语法子集开始，逐步扩展
3. **定期集成**：定期合并代码并测试
4. **代码评审**：实施交叉代码审查

### 编译流程图

```
+--------------------+     +-------------------+     +----------------------+
| 源代码 (SysY语言)   | --> | 词法分析 (Flex)     | --> | 语法分析 (Bison)     |
+--------------------+     +-------------------+     +----------------------+
                                                               |
                                                               v
+----------------------------+     +------------------+     +----------------------+
| LLVM链接并生成可执行文件     | <-- | LLVM IR代码生成     | <-- | 抽象语法树(AST)构建  |
+----------------------------+     +------------------+     +----------------------+
        |                                  ^
        |                                  |
        |                           +-----------------------+
        |                           | IR语义分析与优化        |
        |                           | (可选)                |
        |                           +-----------------------+
        v
+--------------------+
| 程序执行            |
+--------------------+
```

## SysY语言特性简介

SysY是一种C语言的子集，专为编译原理课程设计而创建：

- **基本数据类型**：`int`、`void`
- **变量类型**：支持全局/局部变量、常量、数组
- **表达式**：算术运算、关系运算、逻辑运算
- **控制结构**：if-else、while、break、continue、return
- **函数**：支持定义、声明、递归调用
- **标准库函数**：基本输入输出函数

## 错误处理机制

编译器在各阶段都会提供错误处理：

- **词法分析**：报告未知字符和非法标记
- **语法分析**：提供详细语法错误信息及恢复机制
- **语义分析**：检查类型、作用域和变量使用错误
- **IR生成**：验证生成代码的正确性
- **链接阶段**：提供链接和最终生成阶段的错误报告
